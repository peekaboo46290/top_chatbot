<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphRAG Chatbot</title>
    <link rel="stylesheet" href="stylesheet.css">
</head>
<body>
    <div class="config-button" onclick="openConfig()">‚öôÔ∏è Settings</div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>ü§ñ GraphRAG Assistant</h1>
            <div class="status" id="status">Connecting...</div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    Hello! I'm your GraphRAG-powered assistant. Ask me anything!
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message..."
                onkeypress="handleKeyPress(event)"
            >
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div class="modal" id="configModal">
        <div class="modal-content">
            <h2>Backend Configuration</h2>
            <label>Backend URL:</label>
            <input type="text" id="backendUrl" placeholder="https://your-ngrok-url.ngrok.io">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeConfig()">Cancel</button>
                <button class="save-btn" onclick="saveConfig()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('backendUrl') || 'http://localhost:8000';

        function openConfig() {
            document.getElementById('configModal').classList.add('active');
            document.getElementById('backendUrl').value = API_URL;
        }

        function closeConfig() {
            document.getElementById('configModal').classList.remove('active');
        }

        function saveConfig() {
            API_URL = document.getElementById('backendUrl').value;
            localStorage.setItem('backendUrl', API_URL);
            closeConfig();
            checkBackendStatus();
        }

        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('status').textContent = '‚úì Connected';
                } else {
                    document.getElementById('status').textContent = '‚úó Connection failed';
                }
            } catch (error) {
                document.getElementById('status').textContent = '‚úó Disconnected - Check settings';
            }
        }

        function addMessage(content, isUser, sources = []) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            let html = `<div class="message-content">${content}`;
            
            if (sources && sources.length > 0) {
                html += `<div class="sources">üìö Sources: ${sources.map(s => s.name || 'Knowledge Graph').join(', ')}</div>`;
            }
            
            html += `</div>`;
            messageDiv.innerHTML = html;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, true);
            input.value = '';
            sendButton.disabled = true;
            
            addMessage('<span class="loading"></span> Thinking...', false);
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: 'session_' + Date.now()
                    })
                });
                
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.removeChild(messagesDiv.lastChild);
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.response, false, data.sources);
                } else {
                    addMessage('Sorry, I encountered an error. Please check your backend connection.', false);
                }
            } catch (error) {
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.removeChild(messagesDiv.lastChild);
                addMessage('Error: Could not connect to backend. Please check settings.', false);
            }
            
            sendButton.disabled = false;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        checkBackendStatus();
        setInterval(checkBackendStatus, 30000);
    </script>
</body>
</html>